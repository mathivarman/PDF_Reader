{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ document.title }} - Q&A{% endblock %}

{% block extra_css %}
<style>
    .qa-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .question-input {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
    }
    
    .question-input textarea {
        border: none;
        border-radius: 0.5rem;
        padding: 1rem;
        font-size: 1.1rem;
        resize: vertical;
        min-height: 80px;
    }
    
    .question-input textarea:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
    }
    
    .ask-button {
        background: #28a745;
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .ask-button:hover {
        background: #218838;
        transform: translateY(-2px);
    }
    
    .ask-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
    }
    
    .answer-container {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        display: none;
    }
    
    .answer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f8f9fa;
    }
    
    .answer-badges {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .confidence-badge {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .confidence-badge.low {
        background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    }
    
    .confidence-badge.medium {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    }
    
    .answer-type-badge {
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .grounded-badge {
        background: #17a2b8;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .question-analysis {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #007bff;
    }
    
    .confidence-analysis {
        background: #fff3cd;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #ffc107;
    }
    
    .recommendations-section {
        background: #d1ecf1;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #17a2b8;
    }
    
    .recommendation-item {
        background: white;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid #28a745;
    }
    
    .recommendation-item.critical {
        border-left-color: #dc3545;
        background: #f8d7da;
    }
    
    .recommendation-item.high {
        border-left-color: #fd7e14;
        background: #fff3cd;
    }
    
    .recommendation-item.medium {
        border-left-color: #17a2b8;
        background: #d1ecf1;
    }
    
    .recommendation-item.low {
        border-left-color: #6c757d;
        background: #f8f9fa;
    }
    
    .recommendation-title {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .recommendation-description {
        color: #666;
        margin-bottom: 0.5rem;
    }
    
    .recommendation-reasoning {
        font-style: italic;
        color: #888;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .recommendation-actions {
        margin-top: 0.5rem;
    }
    
    .recommendation-actions ul {
        margin: 0;
        padding-left: 1.5rem;
    }
    
    .recommendation-actions li {
        margin-bottom: 0.25rem;
        color: #555;
    }
    
    .confidence-factor {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: white;
        border-radius: 0.25rem;
    }
    
    .confidence-strength {
        color: #28a745;
        font-weight: 600;
    }
    
    .confidence-weakness {
        color: #dc3545;
        font-weight: 600;
    }
    
    .analysis-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .analysis-item:last-child {
        margin-bottom: 0;
    }
    
    .analysis-label {
        font-weight: 600;
        color: #495057;
    }
    
    .analysis-value {
        color: #6c757d;
    }
    
    .key-terms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .key-term {
        background: #e9ecef;
        color: #495057;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    
    .answer-text {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #333;
        margin-bottom: 1.5rem;
    }
    
    .citations-section {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-top: 1.5rem;
    }
    
    .citation-item {
        background: white;
        border-left: 4px solid #007bff;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.25rem;
    }
    
    .citation-text {
        font-style: italic;
        color: #666;
        margin-bottom: 0.5rem;
    }
    
    .citation-meta {
        font-size: 0.9rem;
        color: #999;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .citation-confidence {
        background: #28a745;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    
    .history-section {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .history-item {
        border-bottom: 1px solid #f8f9fa;
        padding: 1rem 0;
    }
    
    .history-item:last-child {
        border-bottom: none;
    }
    
    .history-question {
        font-weight: 600;
        color: #333;
        margin-bottom: 0.5rem;
    }
    
    .history-answer {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
    }
    
    .history-meta {
        font-size: 0.8rem;
        color: #999;
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .history-type-badge {
        background: #6c757d;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 0.5rem;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .loading-spinner.show {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">{{ document.title|default:document.original_filename }}</h1>
                    <p class="text-muted mb-0">
                        <i class="fas fa-question-circle text-primary me-2"></i>
                        Enhanced Q&A with Advanced Analysis (Week 10)
                    </p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'main:document_detail' document.id %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Analysis
                    </a>
                    <a href="{% url 'main:document_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-list me-2"></i>All Documents
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Q&A Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-number">{{ qa_summary.total_questions }}</div>
                    <div class="stat-label">Total Questions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ qa_summary.avg_confidence|floatformat:1 }}%</div>
                    <div class="stat-label">Avg Confidence</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">{{ qa_summary.avg_processing_time|floatformat:2 }}s</div>
                    <div class="stat-label">Avg Response Time</div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Question Input -->
            <div class="question-input">
                <h4 class="mb-3">
                    <i class="fas fa-question-circle me-2"></i>Ask a Question
                </h4>
                <form id="questionForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <textarea 
                            id="questionText" 
                            name="question_text" 
                            class="form-control" 
                            placeholder="Ask any question about this document..."
                            required></textarea>
                    </div>
                    <button type="submit" class="ask-button" id="askButton">
                        <i class="fas fa-paper-plane me-2"></i>Ask Question
                    </button>
                </form>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <p>Processing your question with advanced analysis...</p>
            </div>

            <!-- Error Message -->
            <div class="error-message" id="errorMessage"></div>

            <!-- Question Analysis (Week 10 Enhancement) -->
            <div class="question-analysis" id="questionAnalysis" style="display: none;">
                <h6 class="mb-3">
                    <i class="fas fa-chart-line me-2"></i>Question Analysis
                </h6>
                <div id="analysisContent"></div>
            </div>

            <!-- Confidence Analysis (Week 11 Enhancement) -->
            <div class="confidence-analysis" id="confidenceAnalysis" style="display: none;">
                <h6 class="mb-3">
                    <i class="fas fa-shield-alt me-2"></i>Confidence Analysis
                </h6>
                <div id="confidenceContent"></div>
            </div>

            <!-- Legal Recommendations (Week 11 Enhancement) -->
            <div class="recommendations-section" id="recommendationsSection" style="display: none;">
                <h6 class="mb-3">
                    <i class="fas fa-gavel me-2"></i>Legal Recommendations
                </h6>
                <div id="recommendationsContent"></div>
            </div>

            <!-- Answer Container -->
            <div class="answer-container" id="answerContainer">
                <div class="answer-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lightbulb text-warning me-2"></i>Answer
                    </h5>
                    <div class="answer-badges">
                        <span class="answer-type-badge" id="answerTypeBadge">Generated</span>
                        <span class="grounded-badge" id="groundedBadge" style="display: none;">
                            <i class="fas fa-check-circle me-1"></i>Grounded
                        </span>
                        <span class="confidence-badge" id="confidenceBadge">85%</span>
                    </div>
                </div>
                <div class="answer-text" id="answerText"></div>
                <div class="citations-section" id="citationsSection" style="display: none;">
                    <h6 class="mb-3">
                        <i class="fas fa-quote-left me-2"></i>Sources & Citations
                    </h6>
                    <div id="citationsList"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Question History -->
            <div class="history-section">
                <h5 class="mb-3">
                    <i class="fas fa-history me-2"></i>Recent Questions
                </h5>
                <div id="questionHistory">
                    {% if recent_questions %}
                        {% for question in recent_questions %}
                        <div class="history-item">
                            <div class="history-question">{{ question.question_text|truncatechars:100 }}</div>
                            <div class="history-answer">{{ question.answer|truncatechars:150 }}</div>
                            <div class="history-meta">
                                <span class="history-type-badge">{{ question.question_type|title }}</span>
                                <span class="badge bg-success">{{ question.confidence_score|floatformat:0 }}%</span>
                                <span class="ms-2">{{ question.created_at|date:"M d, H:i" }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">No questions asked yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const questionForm = document.getElementById('questionForm');
    const questionText = document.getElementById('questionText');
    const askButton = document.getElementById('askButton');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const questionAnalysis = document.getElementById('questionAnalysis');
    const analysisContent = document.getElementById('analysisContent');
    const confidenceAnalysis = document.getElementById('confidenceAnalysis');
    const confidenceContent = document.getElementById('confidenceContent');
    const recommendationsSection = document.getElementById('recommendationsSection');
    const recommendationsContent = document.getElementById('recommendationsContent');
    const answerContainer = document.getElementById('answerContainer');
    const answerText = document.getElementById('answerText');
    const confidenceBadge = document.getElementById('confidenceBadge');
    const answerTypeBadge = document.getElementById('answerTypeBadge');
    const groundedBadge = document.getElementById('groundedBadge');
    const citationsSection = document.getElementById('citationsSection');
    const citationsList = document.getElementById('citationsList');

    questionForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const question = questionText.value.trim();
        if (!question) return;

        // Show loading state
        askButton.disabled = true;
        askButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
        loadingSpinner.classList.add('show');
        answerContainer.style.display = 'none';
        questionAnalysis.style.display = 'none';
        confidenceAnalysis.style.display = 'none';
        recommendationsSection.style.display = 'none';
        errorMessage.style.display = 'none';

        // Send question to server
        fetch(`{% url 'main:ask_question' document.id %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `question_text=${encodeURIComponent(question)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Display question analysis (Week 10 enhancement)
                if (data.question_analysis) {
                    displayQuestionAnalysis(data.question_analysis);
                    questionAnalysis.style.display = 'block';
                }
                
                // Display confidence analysis (Week 11 enhancement)
                if (data.confidence_analysis) {
                    displayConfidenceAnalysis(data.confidence_analysis);
                    confidenceAnalysis.style.display = 'block';
                }
                
                // Display legal recommendations (Week 11 enhancement)
                if (data.recommendations && data.recommendations.total_count > 0) {
                    displayRecommendations(data.recommendations);
                    recommendationsSection.style.display = 'block';
                }
                
                // Display answer
                answerText.textContent = data.answer;
                
                // Update answer type badge
                const answerType = data.answer_type || 'generated';
                answerTypeBadge.textContent = answerType.charAt(0).toUpperCase() + answerType.slice(1);
                
                // Show grounded badge if answer is grounded
                if (data.grounded) {
                    groundedBadge.style.display = 'inline-block';
                } else {
                    groundedBadge.style.display = 'none';
                }
                
                // Update confidence badge
                const confidence = data.confidence_score;
                confidenceBadge.textContent = `${confidence.toFixed(0)}%`;
                confidenceBadge.className = 'confidence-badge';
                
                if (confidence < 50) {
                    confidenceBadge.classList.add('low');
                } else if (confidence < 80) {
                    confidenceBadge.classList.add('medium');
                }
                
                // Display enhanced citations if available
                if (data.citations && data.citations.length > 0) {
                    citationsList.innerHTML = '';
                    data.citations.forEach(citation => {
                        const citationItem = document.createElement('div');
                        citationItem.className = 'citation-item';
                        citationItem.innerHTML = `
                            <div class="citation-text">${citation.text}</div>
                            <div class="citation-meta">
                                <span>Page ${citation.page_number} • ${(citation.similarity_score * 100).toFixed(0)}% relevance</span>
                                <span class="citation-confidence">${citation.confidence.toFixed(0)}% confidence</span>
                            </div>
                        `;
                        citationsList.appendChild(citationItem);
                    });
                    citationsSection.style.display = 'block';
                } else {
                    citationsSection.style.display = 'none';
                }
                
                answerContainer.style.display = 'block';
                
                // Refresh question history
                refreshQuestionHistory();
                
            } else {
                // Show error
                errorMessage.textContent = data.error || 'An error occurred while processing your question.';
                errorMessage.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorMessage.textContent = 'An error occurred while processing your question.';
            errorMessage.style.display = 'block';
        })
        .finally(() => {
            // Reset loading state
            askButton.disabled = false;
            askButton.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Ask Question';
            loadingSpinner.classList.remove('show');
        });
    });

    function displayQuestionAnalysis(analysis) {
        const typeLabels = {
            'factual': 'Factual Question',
            'comparison': 'Comparison Question',
            'procedural': 'Procedural Question',
            'interpretation': 'Interpretation Question',
            'yes_no': 'Yes/No Question',
            'unknown': 'Unknown Type'
        };
        
        const complexityLabels = {
            'simple': 'Simple',
            'medium': 'Medium',
            'complex': 'Complex'
        };
        
        analysisContent.innerHTML = `
            <div class="analysis-item">
                <span class="analysis-label">Question Type:</span>
                <span class="analysis-value">${typeLabels[analysis.question_type] || 'Unknown'}</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Complexity:</span>
                <span class="analysis-value">${complexityLabels[analysis.complexity] || 'Medium'}</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Word Count:</span>
                <span class="analysis-value">${analysis.word_count} words</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Legal Terms:</span>
                <span class="analysis-value">${analysis.has_legal_terms ? 'Yes' : 'No'}</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Key Terms:</span>
                <span class="analysis-value">
                    <div class="key-terms">
                        ${analysis.key_terms.map(term => `<span class="key-term">${term}</span>`).join('')}
                    </div>
                </span>
            </div>
        `;
    }

    function displayConfidenceAnalysis(analysis) {
        confidenceContent.innerHTML = `
            <div class="analysis-item">
                <span class="analysis-label">Overall Confidence:</span>
                <span class="analysis-value">${analysis.overall_confidence.toFixed(1)}%</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Confidence Level:</span>
                <span class="analysis-value">${analysis.confidence_level.replace('_', ' ').toUpperCase()}</span>
            </div>
            <div class="analysis-item">
                <span class="analysis-label">Recommendation:</span>
                <span class="analysis-value">${analysis.recommendation}</span>
            </div>
            ${analysis.strengths.length > 0 ? `
                <div class="mt-3">
                    <strong>Strengths:</strong>
                    <ul class="mt-1">
                        ${analysis.strengths.map(strength => `<li class="confidence-strength">✓ ${strength}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            ${analysis.weaknesses.length > 0 ? `
                <div class="mt-3">
                    <strong>Areas for Improvement:</strong>
                    <ul class="mt-1">
                        ${analysis.weaknesses.map(weakness => `<li class="confidence-weakness">⚠ ${weakness}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        `;
    }

    function displayRecommendations(recommendations) {
        let html = `<div class="mb-3"><strong>${recommendations.summary}</strong></div>`;
        
        // Display by priority
        const priorities = ['critical', 'high', 'medium', 'low'];
        
        for (const priority of priorities) {
            const recs = recommendations.recommendations[priority] || [];
            if (recs.length > 0) {
                html += `<h6 class="mt-3 mb-2">${priority.toUpperCase()} Priority (${recs.length})</h6>`;
                
                recs.forEach(rec => {
                    html += `
                        <div class="recommendation-item ${priority}">
                            <div class="recommendation-title">${rec.title}</div>
                            <div class="recommendation-description">${rec.description}</div>
                            <div class="recommendation-reasoning">${rec.reasoning}</div>
                            <div class="recommendation-actions">
                                <strong>Suggested Actions:</strong>
                                <ul>
                                    ${rec.suggested_actions.map(action => `<li>${action}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                });
            }
        }
        
        recommendationsContent.innerHTML = html;
    }

    function refreshQuestionHistory() {
        fetch(`{% url 'main:question_history' document.id %}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const historyContainer = document.getElementById('questionHistory');
                historyContainer.innerHTML = '';
                
                data.history.forEach(question => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    
                    const typeLabels = {
                        'factual': 'Factual',
                        'comparison': 'Comparison',
                        'procedural': 'Procedural',
                        'interpretation': 'Interpretation',
                        'yes_no': 'Yes/No',
                        'unknown': 'Unknown'
                    };
                    
                    historyItem.innerHTML = `
                        <div class="history-question">${question.question_text}</div>
                        <div class="history-answer">${question.answer}</div>
                        <div class="history-meta">
                            <span class="history-type-badge">${typeLabels[question.question_type] || 'Unknown'}</span>
                            <span class="badge bg-success">${question.confidence_score.toFixed(0)}%</span>
                            <span class="ms-2">${new Date(question.created_at).toLocaleDateString()}</span>
                        </div>
                    `;
                    historyContainer.appendChild(historyItem);
                });
            }
        })
        .catch(error => {
            console.error('Error refreshing history:', error);
        });
    }
});
</script>
{% endblock %}
